# Docker Compose 파일 형식 버전 (최신 엔진에서는 생략 가능)
version: '3.8'

services:
  # [공통 가이드]
  # - build: Dockerfile의 위치와 빌드 맥락(context)을 지정합니다.
  # - container_name: 도커 데스크탑이나 터미널에서 보일 고정 컨테이너 이름입니다.
  # - networks: 컨테이너끼리 내부 통신을 하기 위한 가상 네트워크 연결입니다.
  # - ports: "외부호스트포트:컨테이너내부포트" 형식으로 포트를 매핑합니다.

  # 1. DISCOVERY (EUREKA)
  discovery:
    # 생성될 이미지 이름을 사용자 정의(일관성 확보)
    image: remitro/discovery:latest

    build:
      # 루트 디렉토리를 기준으로 파일을 찾음
      context: .
      dockerfile: infrastructure/discovery/Dockerfile

    container_name: remitro-discovery

    # 유레카 대시보드 접속 포트
    ports:
      - "8761:8761"

    networks:
      - remitro-network

  # 2. GATEWAY
  gateway:
    image: remitro/gateway:latest

    build:
      context: .
      dockerfile: infrastructure/gateway/Dockerfile

    container_name: remitro-gateway

    # 외부 클라이언트가 API 요청을 보내는 관문 포트
    ports:
      - "8080:8080"

    # 의존 관계 설정 (순서 보장 시도)
    depends_on:
      - discovery
      - redis

    # yml 파일의 설정을 무시하고 도커 내부의 discovery 호스트 이름으로 서버를 찾도록 강제함
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery:8761/eureka/

    # Docker 컨테이너 안에서 내 로컬 머신으로 접근 가능
    extra_hosts:
      - "host.docker.internal:host-gateway"

    networks:
      - remitro-network

  # 3. REDIS
  redis:
    # 외부 공식 이미지 사용 (출처 명시를 위해 그대로 유지)
    image: redis:latest

    container_name: remitro-redis

    ports:
      - "6379:6379"

    volumes:
      # 호스트의 특정 폴더에 데이터를 저장하여 컨테이너 재시작 시에도 데이터 유지
      - ./infrastructure/redis/data:/data

    networks:
      - remitro-network

    # 60초 동안 1개 이상의 키가 변경되면 데이터를 디스크에 저장(스냅샷)하도록 설정
    command: redis-server --save 60 1 --loglevel warning

  # 4. MEMBER
  member:
    image: remitro/member:latest

    build:
      context: .
      dockerfile: infrastructure/member/Dockerfile

    container_name: remitro-member

    ports:
      - "8081:8081"

    depends_on:
      - discovery
      - redis

    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery:8761/eureka/

    networks:
      - remitro-network

networks:
  # 모든 서비스가 동일한 네트워크에 있어야 서비스 이름(예: http://discovery:...)으로 통신 가능
  remitro-network:
    driver: bridge
